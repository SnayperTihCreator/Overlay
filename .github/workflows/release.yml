name: Build and Release

on:
  push:
    tags:
      - 'v*' # Сработает при создании тега v1.0 и т.д.
  workflow_dispatch: # Позволит запустить сборку вручную во вкладке Actions

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: win
          - os: ubuntu-latest
            platform: linux

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python 3.11
        run: uv python install 3.11

      - name: Install System Dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libegl1 libopengl0 libxcb-cursor0 libdbus-1-3 \
            libxkbcommon-x11-0 libfontconfig1 libxrender1 libgl1 libglx0

      - name: Install dependencies
        run: uv sync --group dev

      # Собираем GUI (создаст ZIP через твой .spec)
      - name: Build GUI (Overlay)
        run: uv run task build

      # Собираем CLI
      - name: Build CLI (OverlayCLI)
        run: uv run task build-cli

      # ПРИНУДИТЕЛЬНОЕ ПЕРЕИМЕНОВАНИЕ
      - name: Rename Artifacts
        shell: bash
        run: |
          # 1. Определяем версию (если нет тега, ставим 'manual')
          VERSION="${{ github.ref_name }}"
          [ -z "$VERSION" ] && VERSION="manual"
          
          # 2. Переименовываем ZIP (ищем любой созданный твоим спеком .zip)
          mv dist/*.zip dist/Overlay-$VERSION-${{ matrix.platform }}.zip
          
          # 3. Переименовываем CLI
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            mv dist/OverlayCLI.exe dist/OverlayCLI-$VERSION-win.exe
          else
            mv dist/OverlayCLI dist/OverlayCLI-$VERSION-linux
          fi

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/Overlay-*.zip
            dist/OverlayCLI-*
          overwrite: true
          generate_release_notes: true # GitHub сам напишет список изменений
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}